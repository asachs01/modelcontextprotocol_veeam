import fetch from "node-fetch";
import https from "https";
import { z } from "zod";

// Create an HTTPS agent that ignores self-signed certificates
const httpsAgent = new https.Agent({
    rejectUnauthorized: false
});

export default function (server) {
    // Add malware events tool
    server.tool(
        "get-malware-events",
        {
            limit: z.number().min(1).max(1000).default(200).describe("Maximum number of events to retrieve"),
            skip: z.number().min(0).default(0).describe("Number of events to skip (for pagination)")
        },
        async (params) => {
            try {
                if (!global.vbrAuth) {
                    return {
                        content: [{
                            type: "text",
                            text: "Not authenticated. Please call auth-vbr tool first."
                        }],
                        isError: true
                    };
                }

                const { host, token } = global.vbrAuth;
                const { limit = 200, skip = 0 } = params;

                const response = await fetch(`https://${host}:9419/api/v1/malwareDetection/events?limit=${limit}&skip=${skip}`, {
                    method: 'GET',
                    headers: {
                        'accept': 'application/json',
                        'x-api-version': '1.3-rev1',
                        'Authorization': `Bearer ${token}`
                    },
                    agent: httpsAgent
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch malware events: ${response.statusText}`);
                }

                const data = await response.json();

                // Add a summary message
                const total = data.pagination.total;
                const count = data.pagination.count;
                const summary = `Retrieved ${count} malware events out of ${total} total`;

                const formattedResult = {
                    summary,
                    events: data.data.map(event => ({
                        id: event.id,
                        type: event.type,
                        state: event.state,
                        severity: event.severity,
                        machineName: event.machine?.displayName || "Unknown",
                        details: event.details,
                        detectionTimeUtc: event.detectionTimeUtc,
                        creationTimeUtc: event.creationTimeUtc
                    })),
                    pagination: data.pagination
                };

                return {
                    content: [{
                        type: "text",
                        text: JSON.stringify(formattedResult, null, 2)
                    }]
                };
            } catch (error) {
                return {
                    content: [{
                        type: "text",
                        text: `Error fetching malware events: ${error.message}`
                    }],
                    isError: true
                };
            }
        }
    );
}
